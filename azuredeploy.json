{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "StorageAccount": {
      "type": "string",
      "metadata": {
        "description": "Storage Account Name for all VM disks"
      }
    },
    "ArtifactsLocation": {
      "type": "string",
      "metadata": {
        "description": "Location of template Artifacts"
      }
    },
    "ArtifactsLocationSASToken": {
      "type": "string",
      "metadata": {
        "description": "Name of the template Artifacts SAS token"
      }
    },
    "VMName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Virtual Machine"
      }
    },
    "DomainName": {
      "type": "string",
      "metadata": {
        "description": "Name of the AD Domain"
      }
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "Admin user name for the virtual machine"
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Admin user password for virtual machine"
      }
    },
    "vmSize": {
      "type": "string",
      "metadata": {
        "description": "Size of VM"
      }
    },
    "imagePublisher": {
      "type": "string",
      "defaultValue": "MicrosoftWindowsServer"
    },
    "imageOffer": {
      "type": "string",
      "defaultValue": "WindowsServer"
    },
    "osSku": {
      "type": "string",
      "defaultValue": "2016-Datacenter",
      "metadata": {
        "description": "OS sku for VM"
      }
    },
    "nicId": {
      "type": "string",
      "metadata": {
        "description": "Network interface id."
      }
    },
    "PublicDNSName": {
      "type": "string",
      "metadata": {
        "description": "FQDN of VMname"
      }
    },
    "HostDNSNameScriptArgument": {
      "type": "string",
      "metadata": {
        "description": "Full External DNS name"
      }
    },
    "domainJoinOptions": {
      "type": "int",
      "defaultValue": 3,
      "metadata": {
        "description": "Set of bit flags that define the join options. Default value of 3 is a combination of NETSETUP_JOIN_DOMAIN (0x00000001) & NETSETUP_ACCT_CREATE (0x00000002) i.e. will join the domain and create the account on the domain. For more information see https://msdn.microsoft.com/en-us/library/aa392154(v=vs.85).aspx"
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "VM deployment location."
      }
    },
    "tz": {
      "type": "string",
      "metadata": {
        "description": "Time Zone"
      }
    }
  },
  "variables": {
    "DomainController": {
      "type": "string",
      "defaultValue": "DC1"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[parameters('StorageAccount')]",
      "apiVersion": "2016-01-01",
      "location": "[resourceGroup().location]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "Storage",
      "properties": {}
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('vmName'),'/BGInfo')]",
      "apiVersion": "2016-03-30",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines', parameters('Vmname'))]"
      ],
      "properties": {
        "publisher": "Microsoft.Compute",
        "autoUpgradeMinorVersion": "true",
        "typeHandlerVersion": "2.1",
        "type": "BGInfo"
      },

      "comments": "VM Extension to display Background Information."
    },
    {
      "apiVersion": "2017-12-01",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[parameters('vmName')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/', parameters('StorageAccount'))]"
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('vmSize')]"
        },
        "osProfile": {
          "computerName": "[parameters('vmName')]",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]",
          "windowsConfiguration": {
            "provisionVMAgent": "true",
            "enableAutomaticUpdates": "true",
            "timeZone": "[parameters('tz')]"
          }
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "[parameters('imagePublisher')]",
            "offer": "[parameters('imageOffer')]",
            "sku": "[parameters('osSku')]",
            "version": "latest"
          },
          "osDisk": {
            "createOption": "FromImage",
            "name": "[concat(parameters('vmName'), '-OSdisk')]",
            "vhd": {
              "uri": "[concat('https://', parameters('StorageAccount'), '.blob.core.windows.net/vhds/', parameters('VMName'),'disk1.vhd')]"
            },
            "caching": "ReadWrite"
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[parameters('nicId')]"
            }
          ]
        }
      },
      "resources": [
         {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('vmName'),'/joindomain')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines', parameters('Vmname'))]"
      ],
      "condition": "[not(equals(parameters('VMName'), 'WAP'))]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.3",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "Name": "[parameters('DomainName')]",
          "OUPath": "",
          "User": "[concat(parameters('DomainName'), '\\', parameters('AdminUserName'))]",
          "Restart": "true",
          "Options": "[parameters('domainJoinOptions')]"
        },
        "protectedSettings": {
          "Password": "[parameters('adminPassword')]"
        }
      }
    },
        {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "name": "[concat(parameters('vmName'),'/WinRMCustomScriptExtension')]",
          "apiVersion": "2017-03-30",
          "location": "[parameters('location')]",
          "dependsOn": [
            "[concat('Microsoft.Compute/virtualMachines/', parameters('vmName'))]"
          ],
          "properties": {
            "publisher": "Microsoft.Compute",
            "type": "CustomScriptExtension",
            "typeHandlerVersion": "1.4",
            "settings": {
              "fileUris": [
                "https://raw.githubusercontent.com/dbarnett7259/azureRM-Deployments-Templates-Multi-VM/winrm-extension/winRM/ConfigureWinRM.ps1",
                "https://raw.githubusercontent.com/dbarnett7259/azureRM-Deployments-Templates-Multi-VM/winrm-extension/winRM/makecert.exe"
              ],
              "commandToExecute": "[concat('powershell -ExecutionPolicy Unrestricted -file ConfigureWinRM.ps1 ',parameters('hostDNSNameScriptArgument'))]"
                }
            }
          },
        {
            "apiVersion": "2017-12-01",
            "type": "Microsoft.Compute/virtualMachines",
            "name": "[parameters('vmName')]",
            "dependsOn": [
				"[resourceId('Microsoft.Storage/storageAccounts/', parameters('StorageAccount'))]"
			],
            "location": "[resourceGroup().location]",
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('vmSize')]"
                 },
                "osProfile": {
                    "computerName": "[parameters('vmName')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
			    "windowsConfiguration": {
                            "provisionVMAgent": "true",
                            "enableAutomaticUpdates": "true",
                            "timeZone": "[parameters('tz')]"
                    	}
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "[parameters('imagePublisher')]",
                        "offer": "[parameters('imageOffer')]",
                        "sku": "[parameters('osSku')]",
                        "version": "latest"
                 },
                 "osDisk": {
                     "createOption": "FromImage",
                     "name": "[concat(parameters('vmName'), '-OSdisk')]",
                     "vhd": {
                         "uri": "[concat('https://', parameters('StorageAccount'), '.blob.core.windows.net/vhds/', parameters('VMName'),'disk1.vhd')]"
                     },
                     "caching": "ReadWrite"
                    }
                 },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[parameters('nicId')]"
                        }
                    ]
                }
            }
         }
      ]
    }
  ]
}
